<!DOCTYPE html>
<html lang="ko">
<head>
    <title>상품 결제 페이지 | shmpyoshop</title>
    <link rel="stylesheet" href="/project/payment/shmpyo_product_payment.css"/>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="간편하게, 똑똑하게! 손쉽게 완성하는 나를 위한 시스템을 쉼표샵에서 만나보세요.">
    <meta name="robots" content="max-image-preview:large">
    <link href="/IMG/파비콘.svg" rel="shortcut icon" type="image/x-icon">
    <link rel="canonical" href="https://www.shmpyoshop.com/home">
    <meta property="og:locale" content="ko_KR">
    <meta property="og:site_name" content="쉼표샵 shmpyo#">
    <meta property="og:type" content="website">
    <meta property="og:title" content="쉼표샵 - 공식 홈페이지">
    <meta property="og:description" content="간편하게, 똑똑하게! 손쉽게 완성하는 나를 위한 시스템을 쉼표샵에서 만나보세요.">
    <meta property="og:url" content="https://www.shmpyoshop.com/home">
    <meta property="og:image" content="https://media.discordapp.net/attachments/1282189604803444830/1342507726852587580/7d134f0e74b599b0.png?ex=67b9e340&is=67b891c0&hm=6904e632e03d87dbba50a57a111c489a7739896954bfe1a0694361aa5689c343&=&format=webp&quality=lossless">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:image:alt" content="쉼표샵 로고">    

    <meta name="twitter:site" content="https://www.shmpyoshop.com/home">
    <meta name="twitter:title" content="쉼표샵 - 공식 홈페이지">
    <meta name="twitter:description" content="간편하게, 똑똑하게! 손쉽게 완성하는 나를 위한 시스템을 쉼표샵에서 만나보세요.">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image:src" content="https://media.discordapp.net/attachments/1282189604803444830/1342507726852587580/7d134f0e74b599b0.png?ex=67b9e340&is=67b891c0&hm=6904e632e03d87dbba50a57a111c489a7739896954bfe1a0694361aa5689c343&=&format=webp&quality=lossless">
    <script src="https://js.tosspayments.com/v2/standard"></script>
</head>
<body>
    <div id="header-container"></div>

    <div class="info_1_section">
        <div class="find_item">
            <span class="ifo_title_h1">상품 결제하기</span>
            <div class="flexx">

                <div class="section_one">
                    <div class="product_infomation">
                        <div class="flex_sub_title">
                            <svg width="11" height="11" viewBox="0 0 11 11" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M3.31269 11C3.02803 11 2.78599 10.903 2.58658 10.709C2.38717 10.5151 2.28746 10.2798 2.28746 10.003C2.28746 9.72611 2.38717 9.49072 2.58658 9.29682C2.78599 9.10293 3.02803 9.00598 3.31269 9.00598C3.59745 9.00598 3.83954 9.10293 4.03895 9.29682C4.23836 9.49072 4.33807 9.72611 4.33807 10.003C4.33807 10.2798 4.23836 10.5151 4.03895 10.709C3.83954 10.903 3.59745 11 3.31269 11ZM8.9918 11C8.70704 11 8.46496 10.903 8.26555 10.709C8.06613 10.5151 7.96643 10.2798 7.96643 10.003C7.96643 9.72611 8.06613 9.49072 8.26555 9.29682C8.46496 9.10293 8.70704 9.00598 8.9918 9.00598C9.27647 9.00598 9.5185 9.10293 9.71791 9.29682C9.91733 9.49072 10.017 9.72611 10.017 10.003C10.017 10.2798 9.91733 10.5151 9.71791 10.709C9.5185 10.903 9.27647 11 8.9918 11ZM2.22433 1.13944H10.3597C10.5993 1.13944 10.7805 1.23862 10.9032 1.43697C11.0261 1.63524 11.032 1.83772 10.9208 2.04444L9.04351 5.35095C8.94742 5.51531 8.82032 5.64331 8.66222 5.73494C8.50402 5.82666 8.33068 5.87252 8.14221 5.87252H3.86713L3.18877 7.07762C3.15869 7.12149 3.15776 7.16897 3.18599 7.22005C3.21411 7.27123 3.25635 7.29682 3.31269 7.29682H10.017V8.1514H3.31269C2.92207 8.1514 2.62857 7.98761 2.43219 7.66002C2.23571 7.33243 2.22877 7.00536 2.41139 6.67882L3.24736 5.21735L1.11561 0.854579H0V0H1.6677L2.22433 1.13944Z" fill="#C5C7C9"/>
                                </svg>
                                
                                <div class="product_infomation_main_title">상품 정보</div>
                        </div>
                        <div class="flex">
                            <img class="product_image" src="/IMG/product_img/상품준비.png">
                            <div>
                                <div class="product_title">상품 불러오는 중</div>
                                <div class="product_sub_title">비밀코드 1개</div>
                                <div class="amount_Flex">
                                    <div class="product_price">0</div>
                                    <div class="won">원</div>
                                </div>
                            </div>
                        </div>
                    </div>
    
                    <div class="product_infomation">
                        <div class="flex_sub_title">
                            <svg width="11" height="11" viewBox="0 0 11 11" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M5.5 5.26838C4.79417 5.26838 4.18996 5.01048 3.68738 4.49468C3.18468 3.97876 2.93333 3.35859 2.93333 2.63419C2.93333 1.90979 3.18468 1.28969 3.68738 0.773887C4.18996 0.257963 4.79417 0 5.5 0C6.20583 0 6.81004 0.257963 7.31262 0.773887C7.81532 1.28969 8.06667 1.90979 8.06667 2.63419C8.06667 3.35859 7.81532 3.97876 7.31262 4.49468C6.81004 5.01048 6.20583 5.26838 5.5 5.26838ZM0 11V9.32672C0 8.95819 0.0975334 8.61687 0.2926 8.30278C0.487667 7.98868 0.748367 7.74721 1.0747 7.57838C1.79948 7.21373 2.53067 6.94021 3.26828 6.75783C4.00589 6.57544 4.7498 6.48425 5.5 6.48425C6.2502 6.48425 6.9941 6.57544 7.73172 6.75783C8.46933 6.94021 9.20052 7.21373 9.9253 7.57838C10.2516 7.74721 10.5123 7.98868 10.7074 8.30278C10.9025 8.61687 11 8.95819 11 9.32672V11H0Z" fill="#C5C7C9"/>
                                </svg>
                                
                                
                                <div class="product_infomation_main_title">구매자 정보</div>
                        </div>
                        <div class="flex_input space">
                            <p class="sub_title" id="one_title_name">
                                <span class="required">*</span>이름
                            </p>
                            <input type="text" id="name" class="input_one_section" placeholder="이름을 입력해 주세요">
                            <div class="error" id="error-message-name"></div>
                        </div>
                        <div class="flex_input space">
                            <p class="sub_title" id="one_title_phone">
                                <span class="required">*</span>전화번호
                            </p>
                            <input type="text" id="phone" class="input_one_section" placeholder="전화번호를 입력해 주세요">
                            <div class="error" id="error-message-phone"></div>
                        </div>
                        <div class="flex_input">
                            <p class="sub_title" id="one_title">
                                로블록스 닉네임
                            </p>
                            <input type="text" id="robloxName" class="input_one_section" placeholder="로블록스 닉네임을 입력해 주세요">
                        </div>
                    </div>

                    <div class="product_infomation">
                        <div class="flex_sub_title">
                            <svg width="11" height="9" viewBox="0 0 11 9" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M1.04659 9C0.754127 9 0.506579 8.895 0.303947 8.685C0.101316 8.475 0 8.21845 0 7.91535V1.08465C0 0.78155 0.101316 0.525 0.303947 0.315C0.506579 0.105 0.754127 0 1.04659 0H9.95341C10.2459 0 10.4934 0.105 10.6961 0.315C10.8987 0.525 11 0.78155 11 1.08465V7.91535C11 8.21845 10.8987 8.475 10.6961 8.685C10.4934 8.895 10.2459 9 9.95341 9H1.04659ZM0.868421 4.2576H10.1316V2.3424H0.868421V4.2576Z" fill="#C6C7C9"/>
                            </svg>
  
                            <div class="product_infomation_main_title">결제 방법</div>
                        </div>
                        <div id="payment-method"></div>
                    </div>


                    <div class="product_infomation end">
                        <div class="flex_sub_title">
                            <svg width="11" height="11" viewBox="0 0 11 11" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M10.6948 6.77484L6.78037 10.6861C6.67511 10.7907 6.55667 10.8692 6.42504 10.9216C6.29342 10.9739 6.16218 11 6.03133 11C5.90038 11 5.76943 10.9739 5.63848 10.9216C5.50753 10.8692 5.38972 10.7907 5.28504 10.6861L0.305354 5.71595C0.206563 5.621 0.130949 5.50955 0.0785114 5.38161C0.0261704 5.25366 0 5.11905 0 4.97779V1.05209C0 0.762811 0.102316 0.515118 0.306948 0.309013C0.511676 0.103004 0.760344 0 1.05295 0H4.98185C5.12178 0 5.25732 0.0283685 5.38846 0.0851053C5.5197 0.141746 5.63341 0.218022 5.7296 0.313934L10.6948 5.28405C10.8009 5.38923 10.8783 5.50753 10.927 5.63895C10.9757 5.77046 11 5.90232 11 6.03451C11 6.16671 10.9757 6.29668 10.927 6.42443C10.8783 6.55228 10.8009 6.66909 10.6948 6.77484ZM2.33217 3.05612C2.53419 3.05612 2.7058 2.98578 2.84698 2.84509C2.98807 2.70441 3.05861 2.53352 3.05861 2.33243C3.05861 2.1299 2.98821 1.95776 2.84742 1.81601C2.70662 1.67417 2.53559 1.60325 2.33434 1.60325C2.13164 1.60325 1.95936 1.67393 1.8175 1.81529C1.67554 1.95665 1.60456 2.12831 1.60456 2.33026C1.60456 2.53212 1.6753 2.70359 1.81677 2.84466C1.95825 2.98563 2.13004 3.05612 2.33217 3.05612Z" fill="#C5C7C9"/>
                            </svg>
                        
                            <div class="product_infomation_main_title">쿠폰 적용</div>
                        </div>
                        <div class="flex_inputt">
                            <p class="sub_title" id="one_title_coupon">
                                쿠폰 번호
                            </p>
                            <div class="flex_coupon">
                                <input type="text" id="coupon_number" class="input_one_section coupon" placeholder="쿠폰 번호를 입력해 주세요">
                                <button class="verify_button" id="check_coupon">확인하기</button>
                            </div>
                            <div class="error" id="error-message-coupon"></div>

                        </div>
                    </div>
    
                </div>
    
                <div class="section_two">
                    <div class="product_infomation right">
                        <div class="flex_sub_title">
                            <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M5.35719 9.94049H6.61554V9.2929C7.09391 9.18106 7.49408 8.98547 7.81605 8.70614C8.13812 8.4269 8.29915 7.99564 8.29915 7.41233C8.29915 7.00371 8.1894 6.62335 7.9699 6.27128C7.75049 5.91921 7.30181 5.62756 6.62386 5.39633C6.08738 5.21448 5.71221 5.05835 5.49835 4.92796C5.28449 4.79748 5.17756 4.62695 5.17756 4.41636C5.17756 4.23159 5.24716 4.0862 5.38637 3.98018C5.52559 3.87425 5.72381 3.82128 5.98104 3.82128C6.27319 3.82128 6.49883 3.89602 6.65795 4.04551C6.81708 4.1949 6.92646 4.38644 6.98611 4.62013L8.14721 4.14862C8.05001 3.76318 7.86688 3.43725 7.59783 3.17083C7.32886 2.90432 7.01053 2.7492 6.64281 2.70546V2.05951H5.38447V2.70983C4.90928 2.8274 4.54625 3.0483 4.29538 3.37255C4.04451 3.6968 3.91907 4.05801 3.91907 4.45618C3.91907 4.91891 4.05638 5.29958 4.33098 5.59819C4.60558 5.89689 5.03799 6.14744 5.6282 6.34984C6.13421 6.52815 6.49615 6.69028 6.71401 6.83622C6.93178 6.98206 7.04067 7.17324 7.04067 7.40974C7.04067 7.6627 6.9562 7.84956 6.78725 7.97031C6.61822 8.09106 6.38108 8.15144 6.07583 8.15144C5.78096 8.15144 5.5234 8.05724 5.30318 7.86884C5.08304 7.68043 4.93205 7.38106 4.85022 6.9707L3.66184 7.42256C3.76577 7.93421 3.96736 8.34462 4.2666 8.65377C4.56593 8.96292 4.92946 9.16383 5.35719 9.25648V9.94049ZM6 12C5.16947 12 4.38808 11.8441 3.65584 11.5322C2.92351 11.2203 2.28706 10.7941 1.74649 10.2535C1.20593 9.71294 0.779705 9.07649 0.467823 8.34416C0.155941 7.61192 0 6.83053 0 6C0 5.16719 0.156214 4.3849 0.468641 3.65311C0.781069 2.92132 1.20843 2.28447 1.75072 1.74254C2.29311 1.20061 2.92955 0.774703 3.66007 0.464822C4.39058 0.15494 5.17056 0 6 0C6.83272 0 7.61506 0.154895 8.34703 0.464685C9.0789 0.774476 9.71581 1.20034 10.2577 1.74227C10.7997 2.28419 11.2255 2.92123 11.5353 3.65338C11.8451 4.38553 12 5.1681 12 6.00109C12 6.83417 11.8451 7.61488 11.5352 8.34321C11.2253 9.07154 10.7994 9.70689 10.2575 10.2493C9.71553 10.7916 9.07868 11.2189 8.34689 11.5314C7.6151 11.8438 6.83281 12 6 12Z" fill="#C5C7C9"/>
                            </svg>

                            <div class="product_infomation_main_title end">결제 금액</div>
                        </div>
                        <div class="product_price_infomation_price_section">
                            <div class="product_price_sub_title">상품 가격</div>
                            <div class="product_price_sub_price">0원</div>
                        </div>
                        <div class="product_price_infomation_price_section">
                            <div class="product_price_sub_title">쿠폰 할인</div>
                            <div class="product_price_sub_price" id="coupon_input">0원</div>
                        </div>

                        <div class="line"></div>
    
                        <div class="product_price_infomation_price_section end">
                            <div class="product_but_title">총 결제 금액</div>
                            <div class="amount_Flex end">
                                <div class="product_but_price">0</div>
                                <div class="won end">원</div>
                            </div>
                        </div>

                        <div id="agreement"></div>    
                        <button class="verify_button end" id="registerBtn">상품 구매하기<svg width="10" height="10" viewBox="0 0 10 10" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M7.40741 5.48333H0.158325V4.22917H7.40741L4.0846 0.906355L4.98541 0L9.84166 4.85625L5.01458 9.68333L4.11376 8.77698L7.40741 5.48333Z" fill="#3485FF"/>
                        </svg></button>


                    </div>
                </div>
            </div>
            <div class="product_infomation end">
                <div class="flex_sub_title">

                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M7.99999 14.9565C7.77199 14.9565 7.55077 14.9117 7.33632 14.8222C7.12188 14.7325 6.92593 14.6056 6.74849 14.4413L1.55865 9.2515C1.39443 9.07406 1.26749 8.87811 1.17782 8.66367C1.08827 8.44923 1.04349 8.228 1.04349 8C1.04349 7.772 1.08782 7.54795 1.17649 7.32784C1.26504 7.10784 1.39243 6.91473 1.55865 6.7485L6.74849 1.55867C6.92593 1.37945 7.12188 1.24878 7.33632 1.16667C7.55077 1.08456 7.77199 1.0435 7.99999 1.0435C8.22799 1.0435 8.45204 1.08506 8.67216 1.16817C8.89216 1.25117 9.08527 1.38134 9.25149 1.55867L14.4413 6.7485C14.6187 6.91473 14.7488 7.10784 14.8318 7.32784C14.9149 7.54795 14.9565 7.772 14.9565 8C14.9565 8.228 14.9154 8.44923 14.8333 8.66367C14.7512 8.87811 14.6205 9.07406 14.4413 9.2515L9.25149 14.4413C9.08527 14.6076 8.89216 14.7349 8.67216 14.8235C8.45204 14.9122 8.22799 14.9565 7.99999 14.9565ZM7.19199 8.742H8.80799V4.742H7.19199V8.742ZM7.99999 11.0247C8.22888 11.0247 8.42077 10.9472 8.57565 10.7923C8.73054 10.6374 8.80799 10.4456 8.80799 10.2167C8.80799 9.98778 8.73054 9.79589 8.57565 9.641C8.42077 9.48611 8.22888 9.40867 7.99999 9.40867C7.7711 9.40867 7.57921 9.48611 7.42432 9.641C7.26943 9.79589 7.19199 9.98778 7.19199 10.2167C7.19199 10.4456 7.26943 10.6374 7.42432 10.7923C7.57921 10.9472 7.7711 11.0247 7.99999 11.0247Z" fill="#C6C7C9"/>
                        </svg>
                        
                    <div class="product_infomation_main_title info">구매 시, 유의사항</div>
                </div>
                <p class="info_text">쉼표샵 상품은 디지털 콘텐츠의 특성상, 결제 완료 후 단순 변심이나 개인 사유로 인한 환불은 불가합니다. 다만, 쉼표샵 이용약관 제11조에 따라 결제일로부터 7일 이내이며 비밀 코드가 활성화되지 않은 경우에 한해 환불 요청이 가능합니다. 활성화된 코드, 구매자의 실수로 인한 정보 오입력, 코드 분실 등의 경우에는 환불이 불가하니, 구매 시 반드시 정확한 정보를 입력해 주시기 바랍니다.

                    모든 비밀 코드는 개인 사용을 원칙으로 하며, 쉼표샵 이용약관 제15조 및 제16조에 따라 타인에게의 양도, 공유, 재판매, 수정 후 재배포는 금지됩니다. 이러한 행위가 확인될 경우 서비스 이용이 제한되고, 고객 지원이 중단되며, 저작권 침해에 대한 법적 조치가 진행될 수 있습니다.
                    
                    또한 쉼표샵 이용약관 제3조에 따라, 이용자는 상품 구매 시 약관, 환불 조건, 개인정보 제공 등에 동의해야 하며, 구매 진행을 위해서는 이용약관 동의 체크를 필수로 완료해야 합니다. 약관 동의 후 결제가 진행된 경우, 해당 내용에 동의한 것으로 간주됩니다.
                    
                    상품 사용 중 발생하는 오류, 버그 신고 및 기타 이용 문의는 디스코드 고객센터 또는 카카오톡 고객센터를 통해 접수해 주시기 바랍니다.</p>

            </div>
        </div>
    </div>

    <iframe src="/footer.html" style="width: 100%; height: 250px; max-height: 250px; border: none; overflow: hidden;"></iframe>
    <script src="/Js/scrollTop.js"></script>
    
    <script>
        document.getElementById('name').addEventListener('focus', () => {
            document.getElementById('error-message-name').textContent = '';

            document.getElementById("name").classList.remove("input_error");
            if (document.getElementById("one_title_name")) document.getElementById("one_title_name").classList.remove("error_title");
    
        });

        document.getElementById('phone').addEventListener('focus', () => {
            document.getElementById('error-message-phone').textContent = '';
            document.getElementById("phone").classList.remove("input_error");
            if (document.getElementById("one_title_phone")) document.getElementById("one_title_phone").classList.remove("error_title");
    
        });

        document.getElementById('coupon_number').addEventListener('focus', () => {
            document.getElementById('error-message-coupon').textContent = '';
            document.getElementById("coupon_number").classList.remove("input_error");
            if (document.getElementById("one_title_coupon")) document.getElementById("one_title_coupon").classList.remove("error_title");
            
            document.getElementById("robloxName").classList.remove("input_error");
            if (document.getElementById("one_title")) document.getElementById("one_title").classList.remove("error_title");
        });

        document.getElementById('robloxName').addEventListener('focus', () => {
            document.getElementById('error-message-coupon').textContent = '';
            document.getElementById("robloxName").classList.remove("input_error");
            if (document.getElementById("one_title")) document.getElementById("one_title").classList.remove("error_title");
    
        });
    </script>
    
    <script>
        fetch('/header.html')
            .then(response => response.text())
            .then(data => {
                document.getElementById('header-container').innerHTML = data;
        });

        let productId = null;
        let all_price = null;
        let imagelink = null;

        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const name = urlParams.get('name');

            loadProductInfo(code)
                .then(() => {
                    main();
                })
                .catch((error) => {
                    alert('상품 정보를 불러오는 데 실패했어요.');
                    window.close();
                });
        };

        async function loadProductInfo(code) {
            const response = await fetch(`/get-product-info/${code}`);
            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error);
            }

            const { name, price, discount, tag, res, pus, vis } = data;
            if (pus === "F") {
                alert("현재는 판매되지 않는 상품이에요. 구매하시려는 상품을 다시 한번 확인해 주세요.")
                history.back();
                return;
            }

            let formattedPrice;
            if (discount && discount !== "0") {
                const discountedPrice = price - (price * (parseInt(discount) / 100));
                formattedPrice = discountedPrice;
            } else {
                formattedPrice = price;
            }

            all_price = formattedPrice;

            document.getElementsByClassName("product_price")[0].textContent = formattedPrice.toLocaleString();
            if (discount !== "0") {
                document.getElementsByClassName("product_price_sub_price")[0].textContent = formattedPrice.toLocaleString() + '원 (-' + discount + '%)';
            } else {
                document.getElementsByClassName("product_price_sub_price")[0].textContent = formattedPrice.toLocaleString() + '원';
            }
            document.getElementsByClassName("product_but_price")[0].textContent = formattedPrice.toLocaleString();

            document.querySelector('.product_title').textContent = name;
            const imageUrl = `/IMG/product_img/${code}.png`;
            imagelink = code;
            document.querySelector('.product_image').src = imageUrl;
        }



        async function main() {
            const button = document.getElementById("registerBtn");
            const response = await fetch('/get-client-key');
            const data = await response.json();
            const clientKey = data.clientKey;
            const tossPayments = TossPayments(clientKey);
            const customerKey = "shmpyoshopProducts";
            const widgets = tossPayments.widgets({
                customerKey,
            });

            const couponNbInput = document.getElementById("coupon_number");
            const rbnameInput = document.getElementById("robloxName");

            await widgets.setAmount({
                currency: "KRW",
                value: parseFloat(all_price),
            });

            let isCouponApplied = false;

            document.getElementById("check_coupon").addEventListener("click", async function () {
                if (isCouponApplied) {
                    document.getElementById('error-message-coupon').textContent = '한 가지 쿠폰만 적용할 수 있어요';
                    return;
                }

                const couponNb = couponNbInput.value.trim();
                const rbname = rbnameInput.value.trim();

                if (!couponNb) {
                    document.getElementById('error-message-coupon').textContent = '쿠폰번호를 입력하세요';
                    document.getElementById("coupon_number").classList.add("input_error");
                    if (document.getElementById("one_title_coupon")) document.getElementById("one_title_coupon").classList.add("error_title");
                    return;
                }

                if (!rbname) {
                    document.getElementById('error-message-coupon').textContent = '로블록스 닉네임을 입력하세요';
                    document.getElementById("robloxName").classList.add("input_error");
                    if (document.getElementById("one_title")) document.getElementById("one_title").classList.add("error_title");
                    return;
                }

                const response = await fetch('/check_coupon_code', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ coupon_nb: couponNb, rbname, all_price })
                });

                const result = await response.json();

                if (result.success) {
                    document.getElementsByClassName("product_but_price")[0].textContent = `${result.finalPrice}`;
                    document.getElementById('coupon_input').textContent = `-${result.discountAmount}원`;

                    let cleanPrice = result.finalPrice.replace(/,/g, '');
                    cleanPrice = parseFloat(cleanPrice);
                    all_price = cleanPrice;

                    await widgets.setAmount({
                        currency: "KRW",
                        value: cleanPrice,
                    });

                    isCouponApplied = true;
                } else {
                    document.getElementById('error-message-coupon').textContent = result.message;
                }
            });


            await Promise.all([
                widgets.renderPaymentMethods({
                    selector: "#payment-method", 
                    variantKey: "DEFAULT",
                }),
                widgets.renderAgreement({
                    selector: "#agreement", 
                    variantKey: "AGREEMENT"
                })
            ]);

            button.addEventListener("click", async function () {
                const orderId = "SP" + Date.now();
                const orderName = document.querySelector(".product_title").textContent;

                const customerName = document.getElementById("name").value.trim();
                const customerMobilePhone = document.getElementById("phone").value.trim();


                if (!customerName) {
                    document.getElementById('error-message-name').textContent = '이름을 입력하세요';
                    document.getElementById("name").classList.add("input_error");
                    if (document.getElementById("one_title_name")) document.getElementById("one_title_name").classList.add("error_title");
                    return;
                }

                if (!customerMobilePhone) {
                    document.getElementById('error-message-phone').textContent = '전화번호를 입력하세요';
                    document.getElementById("phone").classList.add("input_error");
                    if (document.getElementById("one_title_phone")) document.getElementById("one_title_phone").classList.add("error_title");

                    return;
                }

                if (!/^\d{10,11}$/.test(customerMobilePhone)) {
                    document.getElementById('error-message-phone').textContent = '전화번호 형식을 확인해 주세요 (-빼고 입력)';
                    document.getElementById("phone").classList.add("input_error");
                    if (document.getElementById("one_title_phone")) document.getElementById("one_title_phone").classList.add("error_title");

                    return;
                }


                try {
                    const rbname = rbnameInput.value.trim();
                    const response = await fetch('/check_roblox_name', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ rbname })
                    });

                    const result = await response.json();
                    if (result.success) {
                        if (result.message) {
                            const userConfirmed = confirm(result.message);
                            if (userConfirmed) {
                                window.location.href = 'https://discord.gg/V4T4MKerGj', '_blank';
                                return
                            }
                        }
                    }

                    await widgets.requestPayment({
                        orderId: orderId,
                        orderName: orderName,
                        successUrl: `${window.location.origin}/order_success.html?orderName=${encodeURIComponent(orderName)}&productId=${encodeURIComponent(imagelink)}&customerName=${encodeURIComponent(customerName)}&customerPhone=${encodeURIComponent(customerMobilePhone)}&coupon=${encodeURIComponent(couponNbInput.value.trim())}&roblox=${encodeURIComponent(robloxName.value.trim())}`,
                        failUrl: window.location.origin + "/fail.html",
                        customerName: customerName,
                        customerMobilePhone: customerMobilePhone
                    });
                } catch (error) {
                    if (error.message && error.message.includes('필수 약관에 동의해주세요')) {
                        alert('구매를 진행하시려면, 필수 이용약관에 동의해 주세요.');
                        return;
                    }
                }

            });
        }

    </script>
</body>
</html>
