<!DOCTYPE html>
<html lang="ko">
<head>
    <title>상품 결제 페이지 | shmpyoshop</title>
    <link rel="stylesheet" href="/project/payment/shmpyo_product_payment.css"/>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="간편하게, 똑똑하게! 손쉽게 완성하는 나를 위한 시스템을 쉼표샵에서 만나보세요.">
    <meta name="robots" content="max-image-preview:large">
    <link href="/IMG/파비콘.svg" rel="shortcut icon" type="image/x-icon">
    <link rel="canonical" href="https://www.shmpyoshop.com/home">
    <meta property="og:locale" content="ko_KR">
    <meta property="og:site_name" content="쉼표샵 shmpyo#">
    <meta property="og:type" content="website">
    <meta property="og:title" content="쉼표샵 - 공식 홈페이지">
    <meta property="og:description" content="간편하게, 똑똑하게! 손쉽게 완성하는 나를 위한 시스템을 쉼표샵에서 만나보세요.">
    <meta property="og:url" content="https://www.shmpyoshop.com/home">
    <meta property="og:image" content="https://media.discordapp.net/attachments/1282189604803444830/1342507726852587580/7d134f0e74b599b0.png?ex=67b9e340&is=67b891c0&hm=6904e632e03d87dbba50a57a111c489a7739896954bfe1a0694361aa5689c343&=&format=webp&quality=lossless">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:image:alt" content="쉼표샵 로고">    

    <meta name="twitter:site" content="https://www.shmpyoshop.com/home">
    <meta name="twitter:title" content="쉼표샵 - 공식 홈페이지">
    <meta name="twitter:description" content="간편하게, 똑똑하게! 손쉽게 완성하는 나를 위한 시스템을 쉼표샵에서 만나보세요.">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image:src" content="https://media.discordapp.net/attachments/1282189604803444830/1342507726852587580/7d134f0e74b599b0.png?ex=67b9e340&is=67b891c0&hm=6904e632e03d87dbba50a57a111c489a7739896954bfe1a0694361aa5689c343&=&format=webp&quality=lossless">
    <script src="https://js.tosspayments.com/v2/standard"></script>
</head>
<body>
    <div id="header-container"></div>

    <div class="info_1_section">
        <div class="find_item">
            <h1 class="ifo_title_h1">결제를 시작할게요</h1>
            <div class="flex">

                <div class="section_one">
                    <div class="product_infomation">
                        <div class="product_infomation_main_title">상품 정보</div>
                        <div class="flex">
                            <img class="product_image" src="/IMG/product_img/상품준비.png">
                            <div>
                                <div class="product_title">상품 불러오는 중</div>
                                <div class="product_sub_title">비밀코드 1개</div>
                                <div class="product_price"></div>
                            </div>
                        </div>
                    </div>
    
                    <div class="product_order_infomation">
                        <div class="product_order_infomation_main_title">주문자 정보</div>
                        <div class="flex_input">
                            <p class="sub_title" id="one_title"><span class="required">*</span>이름</p>
                            <div class="error" id="error-message-name" style="color: #D58181;"></div>
                        </div>
                        <input type="text" id="name" class="input_one_section">
                        
                        <div class="flex_input">
                            <p class="sub_title" id="one_title"><span class="required">*</span>전화번호</p>
                            <div class="error" id="error-message-phone" style="color: #D58181;"></div>
                        </div>
                        <input type="text" id="phone" class="input_one_section">
    
                        <div class="flex_input">
                            <p class="sub_title" id="one_title">(선택) 로블록스 닉네임</p>
                            <div class="error" id="error-message-roblox" style="color: #D58181;"></div>
                        </div>
                        <input type="text" id="robloxName" class="input_one_section">
                    </div>

                    <div class="product_all_price_infomation">
                        <div class="product_all_price_infomation_price_section">
                            <div class="product_all_price_infomation_main_title">결제 방법</div>
                            <div id="payment-method"></div>
                        </div>
                    </div>
    
                    <div class="product_coupon">
                        <div class="product_coupon_main_title">쿠폰 적용</div>
                        <div class="flex_input">
                            <p class="sub_title" id="one_title">쿠폰번호</p>
                            <div class="error" id="error-message-coupon" style="color: #D58181;"></div>
                        </div>
                        <div class="secretcode_input">
                            <input type="text" id="coupon_number" class="input_two_section">
                            <button class="verify_button" id="check_coupon">확인</button>
                        </div>
                    </div>
                </div>
    
                <div class="section_two">
                    <div class="product_price_infomation">
                        <div class="pproduct_price_infomation_main_title">결제 금액</div>
                        <div class="product_price_infomation_price_section">
                            <div class="product_price_sub_title">상품 가격</div>
                            <div class="product_price_sub_price"></div>
                        </div>
                        <div class="product_price_infomation_price_section">
                            <div class="product_price_sub_title">쿠폰 할인</div>
                            <div class="product_price_sub_price" id="coupon_input">0원</div>
                        </div>

                        <div class="line"></div>
    
                        <div class="product_price_infomation_price_section">
                            <div class="product_but_title">총 결제 금액</div>
                            <div class="product_but_price"></div>
                        </div>

                        <div id="agreement"></div>

                        <div class="lastbutton" id="lastbutton">
                            <button class="input_button_section" id="registerBtn">구매하기</button>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <iframe src="/footer.html" style="width: 100%; height: 250px; max-height: 250px; border: none; overflow: hidden;"></iframe>
    <script src="/Js/scrollTop.js"></script>
    <script>
        fetch('/header.html')
            .then(response => response.text())
            .then(data => {
                document.getElementById('header-container').innerHTML = data;
        });

        let productId = null;
        let all_price = null;
        let imagelink = null

        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const name = urlParams.get('name');

            loadProductInfo(code)
                .then(() => {
                    main();
                })
                .catch((error) => {
                    console.error('상품 정보 로드 오류:', error);
                    alert('상품 정보를 불러오는 데 실패했습니다.');
                });
        };

        async function loadProductInfo(code) {
            const response = await fetch(`/get-product-info/${code}`);
            const data = await response.json();
            console.log(data);
            
            if (data.error) {
                throw new Error(data.error);
            }

            const { name, price, discount } = data;
            console.log(name, price, discount);

            // 할인율이 있을 경우 할인 적용
            let formattedPrice;
            if (discount && discount !== "0") {
                // 할인율이 존재하면 가격에서 할인액을 빼기
                const discountedPrice = price - (price * (parseInt(discount) / 100));
                formattedPrice = discountedPrice;
            } else {
                formattedPrice = price;
            }

            all_price = formattedPrice;

            // 가격 표시
            document.getElementsByClassName("product_price")[0].textContent = formattedPrice.toLocaleString() + '원';
            if (discount !== "0") {
                document.getElementsByClassName("product_price_sub_price")[0].textContent = formattedPrice.toLocaleString() + '원 (-' + discount + '%)';
            } else {
                document.getElementsByClassName("product_price_sub_price")[0].textContent = formattedPrice.toLocaleString() + '원';
            }
            document.getElementsByClassName("product_but_price")[0].textContent = formattedPrice.toLocaleString() + '원';

            // 상품 제목과 이미지 업데이트
            document.querySelector('.product_title').textContent = name;
            const imageUrl = `/IMG/product_img/${code}.png`;
            imagelink = code;
            document.querySelector('.product_image').src = imageUrl;
        }



        async function main() {
            const button = document.getElementById("registerBtn");
            const response = await fetch('/get-client-key');
            const data = await response.json();
            const clientKey = data.clientKey;
            const tossPayments = TossPayments(clientKey);
            const customerKey = "shmpyoshopProducts";
            const widgets = tossPayments.widgets({
                customerKey,
            });

            const couponNbInput = document.getElementById("coupon_number");
            const rbnameInput = document.getElementById("robloxName");

            await widgets.setAmount({
                currency: "KRW",
                value: parseFloat(all_price),
            });

            document.getElementById("check_coupon").addEventListener("click", async function () {
                const couponNb = couponNbInput.value.trim();
                const rbname = rbnameInput.value.trim();

                if (!couponNb) {
                    document.getElementById('error-message-coupon').textContent = '쿠폰번호를 입력하세요';
                    return;
                }

                const response = await fetch('/check_coupon_code', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ coupon_nb: couponNb, rbname, all_price })
                    
                });

                const result = await response.json();

                if (result.success) {
                    document.getElementsByClassName("product_but_price")[0].textContent = `${result.finalPrice}원`;
                    document.getElementById('coupon_input').textContent = `-${result.discountAmount}원`;

                    let cleanPrice = result.finalPrice.replace(/,/g, '');
                    cleanPrice = parseFloat(cleanPrice);
                    all_price = cleanPrice;

                    await widgets.setAmount({
                        currency: "KRW",
                        value: cleanPrice,
                    });
                } else {
                    document.getElementById('error-message-coupon').textContent = result.message;
                }
            });

            await Promise.all([
                widgets.renderPaymentMethods({
                    selector: "#payment-method", 
                    variantKey: "DEFAULT",
                }),
                widgets.renderAgreement({
                    selector: "#agreement", 
                    variantKey: "AGREEMENT"
                })
            ]);

            button.addEventListener("click", async function () {
            const orderId = "SP" + Date.now();
            const orderName = document.querySelector(".product_title").textContent;

            const customerName = document.getElementById("name").value.trim();
            const customerMobilePhone = document.getElementById("phone").value.trim();

            if (!customerName || !customerMobilePhone || !/^\d{10,11}$/.test(customerMobilePhone)) {
                document.getElementById('error-message-name').textContent = '이름을 입력하세요';
                document.getElementById('error-message-phone').textContent = '전화번호를 입력하세요';
                return;
            }

            const rbname = rbnameInput.value.trim();
            const response = await fetch('/check_roblox_name', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ rbname })
            });

            const result = await response.json();
            if (result.success) {
                if (result.message) {
                    const userConfirmed = confirm(result.message);
                    if (userConfirmed) {
                        window.location.href = 'https://discord.gg/V4T4MKerGj', '_blank';
                        return
                    }
                }
            }


            await widgets.requestPayment({
                orderId: orderId,
                orderName: orderName,
                successUrl: `${window.location.origin}/order_success.html?orderName=${encodeURIComponent(orderName)}&productId=${encodeURIComponent(imagelink)}&customerName=${encodeURIComponent(customerName)}&customerPhone=${encodeURIComponent(customerMobilePhone)}&coupon=${encodeURIComponent(couponNbInput.value.trim())}&roblox=${encodeURIComponent(robloxName.value.trim())}`,
                failUrl: window.location.origin + "/fail.html",
                customerName: customerName,
                customerMobilePhone: customerMobilePhone
            });
        });

        }

    </script>
</body>
</html>
